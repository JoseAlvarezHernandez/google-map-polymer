<link rel="import" href="../../../polymer/polymer-element.html">
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAXZGsFjMGp0Xlf5vDnNtk35gHdWHA1jIo">
</script>
<dom-module id="google-map">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <h2>Hello {{name}}!</h2>
        <div id="map" style="height:[[height]]; width:[[width]];"></div>
        <div id="coords">
            <label for="name">Name</label>
            <input type="text" name="name" value="{{name::keyup}}">
            <label for="lat">Lat</label>
            <input type="number" name="lat" value="{{lat::change}}">
            <label for="lng">Lng</label>
            <input type="number" name="lng" value="{{lng::change}}">
            <label for="lng">Zoom</label>
            <input type="number" name="zoom" value="{{zoom::change}}">
        </div>
    </template>
    <script>
        /**
         * `googleMap`
         * @customElement
         * @polymer
         * @demo demo/index.html
        */
        class Dumb_element extends Polymer.Element {
            static get is() { return 'google-map'; }
            static get properties() {
                return {
                    name: {
                        type: String,
                        value: 'google-map',
                        notify: true,
                        reflectToAttribute: true
                    },
                    height:{
                        type: String,
                        value: '400px',
                    },
                    width:{
                        type:String,
                        value: '100%'
                    },
                    lat: {
                        type: Number,
                        value: 19.4284700,
                        notify: true,
                        reflectToAttribute: true,
                        observer: '_latChanged'
                    },
                    lng: {
                        type: Number,
                        value: -99.1276600,
                        notify: true,
                        reflectToAttribute: true,
                        observer: '_lngChanged'
                    },
                    zoom: {
                        type: Number,
                        value: 7,
                        notify: true,
                        reflectToAttribute: true,
                        observer: '_zoomChanged'
                    },
                    map: {
                        type: Object,
                        notify: true,
                        value: null
                    },
                    markers: {
                        type: Array,
                        notify: true,
                        value: [],
                        observer: '_activeChanged'
                    },
                    mapsMarkers: {
                        type: Array,
                        value: []
                    }
                };
            }
            ready() {
                super.ready();
                this.initMap();
            }
            attached() {
                super.attached();
            }
            connectedCallback() {
                super.connectedCallback();
            }
            _activeChanged(newVal, oldVal) {
                if (oldVal === undefined)
                    return

                this._reloadMarkers();
            }
            _latChanged(lat) {
                if (lat === undefined || this.map === null)
                    return;

                this.map.setCenter(new google.maps.LatLng(lat, this.lng));
            }
            _lngChanged(lng) {
                if (lng === undefined || this.map === null)
                    return;

                this.map.setCenter(new google.maps.LatLng(this.lat, lng));
            }
            _zoomChanged(zoom) {
                if (zoom === undefined || this.map === null)
                    return;

                this.map.setZoom(Number(zoom));
            }
            _mapOption() {
                let options = {
                    zoom: this.zoom,
                    center: {
                        lat: this.lat,
                        lng: this.lng
                    }
                };
                return options;
            }
            _mapMarkers() {
                this.markers.forEach(marker => {
                    this.mapsMarkers.push(new google.maps.Marker({ position: marker, map: this.map }));
                });
            }

            _reloadMarkers() {
                this.mapsMarkers.forEach((marker) => {
                    marker.setMap(null);
                });
                this._mapMarkers();
            }
            initMap() {
                const loadedMap = setInterval(() => {
                    if (google) {
                        clearInterval(loadedMap);
                        this.map = new google.maps.Map(this.$.map, this._mapOption());
                        this._mapMarkers();
                    }
                }, 2000);

            }

        }
        window.customElements.define(Dumb_element.is, Dumb_element);
    </script>
</dom-module>